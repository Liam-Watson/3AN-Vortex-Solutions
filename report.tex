\documentclass{article}
\DeclareMathSizes{10}{10}{7}{7}
\usepackage{amsmath}
\usepackage{ amssymb }
\usepackage{tikz, graphicx}
\usepackage{geometry}
\usepackage[makeroom]{cancel}
% http://www.mathworks.com/matlabcentral/fileexchange/8015-m-code-latex-package
\usepackage[framed,numbered,autolinebreaks,useliterate]{mcode}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=blue,
    }
\usepackage{float}
\restylefloat{table}

\geometry{legalpaper, margin=0.7in}
\title{3AN Project 1\\ Shooting Newton and Kantorovich with matlab}
\author{Liam Watson WTSLIA001}
\begin{document}
\maketitle
When modeling vortecies a common Boundary Value problem that results is as follows


\begin{align}
&\frac{d^2 u}{dr^2} + \frac{1}{r}\frac{du}{dr} + \frac{u}{1-u^2}\left[\left(\frac{du}{dr}\right)^2 - \frac{n^2}{r^2}\right] + u(1-u^2) = 0 \\
&u(0) = 0,\ \ \  u(\infty) = 1
\end{align}

Where 
\begin{align*}
&n\in \mathbb{N}/\{0\} \text{ Is the vorticity} \\
&u = u(r)  \text{ Is our unknown function that is monotically growing} 
\end{align*}
In this paper we will solve the BVP (1), (2) numerically using the shooting method and the Newton-Kantorovich method for $n\in \{1,2,3\}$. The numerical solution to this BVP is sensitive to many parameters that we must choose. We will discuss the effect of our choices for parameters such as how we deal with $u(\infty)$, $\frac{u1}{1-u^2}$ being undefined at $u = 1$, $u(0) = 0$ but $1/r$ is undefined, the number of itterations, the value for $n$, mesh spacing, length of spacial interval, initial guess.

\section{Numerical methods overview}
Here we will discuss the different numerical schemes with their relative benefits and drawbacks 
\subsection{Shooting method}
The general principle for the shooting method is to reduce our boundary value problem into an initial value problem. We do this by taking the first boundary condition as the first initial condition and some arbitrary second value for the second initial condition, we call this value the shooting parameter. We must then find a value of the shooting parameter so that our second boundary condition is met. We can do thing using the bisection or netwton's method.     
\subsection{Newton-Kantorovich method}
The general principle for Newton-Kantorovich is to find the system of Kantorovich equations. In our case this will produce a second order linear boundary value problem which we can solve using linear shooting or finite difference methods. The solution to this system is the correction to some initial guess for the initial problem to be solved.  
\section{Derevation of needed formula}
In order to begin the implementation we need to first derive the needed expressions from (1) and (2).
\section{Shooting method}
The differential equation in (1) is a non-linear one so we must use non-linear shooting to solve it. \\
First we must derive an initial value problem from the boundary value problem which is described bellow 
\begin{align}
\begin{cases}
u'' = -\frac{1}{r}\frac{du}{dr} - \frac{u}{1-u^2}\left[\left(\frac{du}{dr}\right)^2 - \frac{n^2}{r^2}\right] - u(1-u^2) \\
u(0) = 0 \\
u'(0) = p
\end{cases}
\end{align}
Where $p$ is our shooting parameter. \\
We now have two choice for solving for $p$ namely, bisection or newton's method. 
We do not yet know which of these will give better results so let us implement both.  \\
For bisection there is nothing for us do derive and the details will be covered in the implementation section. \\
For Newtons method we must derive a scheme to update $p$ based on the function $u$ and the seccond boundary condition.\\ 
We introduce:
\begin{align}
f' = \frac{\partial }{\partial p}\left(u(p,x=\infty)-1\right) =  \frac{\partial }{\partial p} u(p,x=\infty) \\
z(p) = \frac{\partial }{\partial p} u(p,x)
\end{align}
Then 
\begin{align}
\begin{cases}
z'' = \frac{\partial f}{\partial y}z + \frac{\partial f}{\partial y'}z' \\
 \frac{\partial f}{\partial y} = \\
 \frac{\partial f}{\partial y'} = \\
\end{cases}
\end{align}
We can use reduction of order to obtain the systems we must solve numerically. 
\begin{align}
\begin{cases}
u' = v \\
v' = -\frac{1}{r}\frac{du}{dr} - \frac{u}{1-u^2}\left[\left(\frac{du}{dr}\right)^2 - \frac{n^2}{r^2}\right] - u(1-u^2) \\
z' = w \\
w = \left(\frac{1+u^2}{(1-u^2)^2}\left[ v^2 + \frac{n^2}{r^2} \right] \right)z + \left(\frac{-1}{r} + \frac{2uv}{1-u^2}\right)w \\
\end{cases}
\end{align}
\section{Newton-Kantorovich}
The first step for the Newton-Kantorovich is to find the Kantorovich equations which we can do by:
\begin{itemize}
\item Find $F(u) = 0$
\item Find $F(y + hz)$
\item Find $\frac{\partial F}{\partial h}$
\item Find $\lim_{h\rightarrow 0} \frac{\partial F}{\partial h}$
\end{itemize}
\begin{enumerate}
\item
\begin{align}
F(y) = 
\begin{cases}
\frac{d^2 u}{dr^2} + \frac{1}{r}\frac{du}{dr} + \frac{u}{1-u^2}\left[\left(\frac{du}{dr}\right)^2 - \frac{n^2}{r^2}\right] + u(1-u^2) = 0 \\
u(0) = 0 \\
u(\infty) = 1\\
\end{cases}
\end{align}
\item
\begin{align}
F(y+hz) = 
\begin{cases}
u\prime\prime + hz\prime\prime + \frac{1}{r}\left(u\prime + hz\prime\right) + \frac{u + zh}{1-(u+zh)^2}\left[(u\prime + hz\prime)^2 - \frac{n^2}{r^2} \right] + (u + hz)(1-(u+hz)^2) = 0 \\
u(0) + hz(0) = 0 \\
u(\infty) + hz(\infty) = 1\\
\end{cases}
\end{align}
\item and 4. assuming we know some approximation $u^n$
\begin{align}
\begin{cases}
z\prime\prime + \frac{1}{r}z\prime + z(1-3u^2) + \frac{1}{1-u^2}\left[ (u\prime)^2  - \frac{n^2}{r^2}\right] = -(u^n)\prime\prime - \frac{1}{r}(u^n)\prime - \frac{u^n}{1-(u^n)^2}\left[\left((u^n)^\prime\right)^2 - \frac{n^2}{r^2}\right] - u^n(1-(u^n)^2) \\
z(0) = -u^n(0) \\
z(\infty) = u^n(\infty) + 1 
\end{cases}
\end{align}
This system (10) is now linear in $z$ so we can solve it using any numerical scheme for linear BVP's. Knowing that the standard form for a linear BVP is
\begin{align}
u^{\prime\prime} = p(r)u^\prime + q(r)u + \xi (r)
\end{align}
Trivially we can find the corresponding $p,q,\xi$ for (10)
\begin{align*}
\begin{cases}
p = \frac{1}{r} _ \frac{2uu^\prime}{1-u^2} \\
q = -3u^2 + 1 + \frac{1}{1-u^2}\left[(u^\prime)^2 -\frac{n^2}{r^2} \right] \\
\xi = u
\end{cases}
\end{align*}
We choose to solve for $z$ using the finite difference method. First we must define a mesh.
\begin{align}
h = \frac{1-0}{N} \ \ \ \ \ \ \text{Where we are free to choose a large N} \\
x_j = (j-1)*h, \ \ \ j = 1,2,3,...,N+1 \\
u_j = u(x_j)
\end{align}
 
We use finite difference approxmiations for $u^\prime$ and $u^{\prime\prime}$
\begin{align}
(u_j)^\prime = \frac{u_{j+1} - u_{j-1}}{2h} \\
(u_j)^{\prime\prime} = \frac{u_{j+1} - 2u_{j} + u_{j-1}}{h^2} \\
\end{align}
We then have our matrix-vector system defined as
\begin{align}
\begin{bmatrix}
1 & 0 & 0 ... 0 \\
1 + \frac{hp_3}{2} & -2 - h^2q_3 & 1 - \frac{hp_3}{2} & 0 &...& 0\\
0 & . & . \\
. & . & . \\
. & . & . \\
0 & ... &0 & & 1 + \frac{hp_N}{2} & -2 - h^2q_3 \\
\end{bmatrix}
\begin{bmatrix}
z_2 \\ z_3 \\ . \\ . \\ . \\ z_N\\
\end{bmatrix}
=
\begin{bmatrix}
h^2 \xi \\
h^2 \xi \\
. \\
. \\
. \\
h^2 \xi - 1
\end{bmatrix}
\end{align}
Which we can solve for $z$ and simplify in matrix-vector notation to
\begin{align}
\vec{z} = \vec{U} A^{-1} 
\end{align}
We then wish to update $u$ using the correction $z$
\begin{align}
u^{n + 1} = u^{n} + z
\end{align}
\end{enumerate}
\section{Implementation}
Here we will discuss the implementation details of the two numerical methods in matlab. \\
If the reader would like to investigate implementation regarding testing and experimental data further see the \href{https://github.com/Liam-Watson/3AN-Vortex-Solutions}{ github repository} for this investigation.

\subsection{Shooting method}
\begin{lstlisting}
a = 0.1; % Boundary one
b = 8; % infinity
n = 1;
%p = 0.2; %Arbitray initial shooting parameter


%file = fopen("inf.txt", 'w');
%fprintf(file,'%6.2f %12.8f\n', n);
%for b = [5:1:25]
    ph = 2; %bisection
    pl = 0;
    p = (ph + pl)/2; %bisection
    tol = 1;
    i = 1;
    u0 = [0,p,0,1];
while i < 300 && tol > 1e-5
   [r,u] = ode45(@shoot, [a:0.2:b], u0);
   %disp(u(end,3))
   plot(r,u(:,1));
   %pause(0.1)
   %disp((u(end,4)))
   tol = abs(1-u(end,1));
   tor = u(end,1);
   if(tor > 1)
      ph = p;
      p = (pl + ph)/2;
      u0 = [0,p,0,1];   
   end
   if(tor < 1)
      pl = p;
      p = (pl + ph)/2;
      u0 = [0,p,0,1];  
   end
   %disp(p)
   %p = p - ((u(end,1)-1)/(u(end,3)));
   %u0 = [0,p,0,1];
   %disp([p,ph,pl])
   %disp(u0);
   i = i + 1;
   plot(r,u(:,1))
   
end
%    bool = tol < 1e-5;%tolerence to be considered stable
%    fprintf(file,'%6.2f %12.8f\n', b, bool);
%end
plot(r,u(:,1))
%fclose(file);
function [du] = shoot(r,u)
    n = 1;
    uu = u(1);
    v = u(2);
    z = u(3);
    w = u(4);
    
    
    du(1,1) = v; %
    du(2,1) = (-1/r)*v  - (uu/(1-uu^2))*(v^2-(n^2)/(r^2)) - uu*(1-uu^2);
    du(3,1) = w; % 
    du(4,1) = z*( -((1 + uu^2)/((1-uu^2)^2))*(v^2 - (n^2)/(r^2)) - 1 + 3*uu^2) + w*(-1/r  - ((2*uu)*v)/(1-uu^2)) ;
    
end
\end{lstlisting}
\pagebreak
\subsection{Newton-Kantorovich method}
\begin{lstlisting}

%h = (b-a)/N;

%r = (a:h:b)';

%Initial guesses
%u = r/b;
%u = log(r + 1)/log(b+1) -a; 
%u = 1./(1+exp(-r + b/2)); 

n = 1; %vorticity 
%file = fopen("inf.txt", 'w');
%for N = [50:100:1950] %Here we loop over our hyperparameters and test for
%stability i.e. N, b, a, etc.
    a = 0.1; %This is our starting position
    b = 5; %infity
    N = 100;
    h = (b-a)/N;
    h2 = h*h;
    r = (a:h:b)';
    u = r/b;
    %u = 1./(1+exp(-r));
    rhs=[u(1);u(1:N-1)-2*u(2:N)+u(3:N+1) + h2.*f(r,u,h, N, n);u(N+1)-1];
    tol = 1;
    count = 1;

while count < 500 && tol > 1e-6
    dd = [0; -2 - h2.*q(r,u,h,N, n) ; 0];
    upper = diag([0;1 - (h*p(r,u,h,N))./2],1);
    lower = diag([1 + (h*p(r,u,h,N))./2;0],-1);
    J = diag(dd,0) + upper + lower;  %Set three diagonal
    J(1,1)=1; J(1,2)=0; J(1,3)=0; %Set BC 1
    J(N+1,N+1)=1; J(N+1,N)=0; J(N+1,N-1)=0; %Set BC 2
    z = -J\rhs; %Solve for correction
    u = u + z; 
    rhs=[u(1);u(1:N-1)-2*u(2:N)+u(3:N+1) + h2.*f(r,u,h,N,n);u(N+1)-1]; 
    tol = norm(rhs) %Display tolerance
    plot(r,u)
    pause(0.05);
    count = count+1;
    
end
%    bool = tol < 1e-5;%tolerence to be considered stable
%    fprintf(file,'%6.2f %12.8f\n', b, bool); %Write stability data
%end %End of for loop
%fclose(file);
%This is f in y'' = f
function [fu] = f(r, u, h, N, n)
    uBefore = u(1:N-1);
    uAfter = u(3:N+1);
    u = u(2:N);
    fu = 1*((1./r(2:N)).*((uAfter - uBefore)/(2*h)) + ((u)./(1-u.^2)).*(((uAfter - uBefore)/(2*h)).^2 - n^2./(r(2:N).^2)) + u.*(1-u.^2));
end 
%This is p in a linear ODE
function [p] = p(r,u,h, N)
    uBefore = u(1:N-1);
    uAfter = u(3:N+1);
    uu = u(2:N);
    r = r(2:N);
    p = -1*(1./r + (2*uu.*((uAfter-uBefore)/(2*h)))./(1-uu.^2));
end


%q(r)
function [q] =  q(r,u, h , N, n)
    r = r(2:N);
    uBefore = u(1:N-1);
    uAfter = u(3:N+1);
    uu = u(2:N);
    q= -1*(-3*uu.^2 + 1 + 1./((1-uu.^2)).*(((uAfter-uBefore)/(2*h)).^2 - (n^2)./(r.^2) )); 
end
\end{lstlisting}
\pagebreak
\section{Results and discussion}
Here we will discuss how the two methods performed and what we learned. \\
The testing stratergy for the hyperparameters was as follows: We must have base stable parameters that we can fix while we vary the others. Let these be

\begin{align*}
 & a = 0.1 \\
 & b = 5 \\
 & N = 50 \\
 & step size = 0.2 \\
 & u^0 = \frac{r}{b} \\
 & p0 = 0.2 \text{ \ \ \ \ For Newton's method in Nonlinear   shooting}\\
 & ph = 4 \text{ \ \ \ \ For bisection in Nonlinear shooting}\\
 & pl = 4 \text{ \ \ \ \ For bisection in Nonlinear shooting}
\end{align*}
Each test will be run until either 100 iterations is reached or the tolerance less than $10^{-7}$. \\
The parameters that we will analyse for stability are $a,b,N,$ step size$,u^0$ and bisection vs newton. \\
A note on interpreting results: For berevity convergence to a stable solution has been represneted by a $1$ and divergence as defined above is represented by a $0$.  
\subsection{Shooting method}
\includegraphics[scale=1]{nonlinearshoot1.png}
We can see a clear pattern forming as $n$ grows. If we continue to solve for $n=4,5,6$ we see a similar trend as $u$ goes to 1 inceasingly slowly. \\
\subsubsection{Varing a}
\begin{table}[H]
\centering
\caption{This table shows the convergence of the nonlinear shooting method with varying a for $n=1,2,3$}
\begin{tabular}{|c|c|c|c|}
\hline
a & n=1 & n=2 & n=3 \\
\hline
0 & 0 & 0 & 0\\
0.001 & 1 & 1 & 0\\
0.002 & 1 & 1 & 0\\
0.003 & 1 & 1 & 0\\
0.004 & 1 & 1 & 0\\
0.005 & 1 & 1 & 0\\
0.006 & 1 & 1 & 0\\
0.007 & 1 & 1 & 0\\
0.008 & 1 & 1 & 0\\
0.009 & 1 & 1 & 1\\
0.01  & 1 & 1 & 1\\
\hline
\end{tabular}
\end{table}
We can see that the shooting method is unstable at $a=0$ as this implies $r=0$. This creates issues with the $\frac{1}{r}$ terms, producing invalid results. This is why for future testing $a=0.1$ is used to ensure stability here. Future investigation could look into using a power series to capture the behavior for small $r$. \\
Additionally we can see that for non-zero $a$ solutions for $n=1$ and $n=2$ are stable, however, $n=3$ begins converging at $a=0.009$. This is likely due to the solutions slow growth to 1 causing poor stability as we force the solution towards 1 which can be seen in figure 1. 
\subsubsection{Varing b}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
b & n=1 & n=2 & n=3   \\
\hline
4  & 1 & 1 & 1\\
6  & 1 & 1 & 1\\
8  & 1 & 1 & 1\\
10 & 1 & 1 & 1\\
12 & 1 & 1 & 1\\
14 & 1 & 1 & 1\\
16 & 0 & 1 & 1\\
18 & 0 & 0 & 0\\
20 & 0 & 0 & 0\\
22 & 0 & 0 & 0\\
24 & 0 & 0 & 0\\
\hline
\end{tabular}
\caption{This table shows the convergence of the nonlinear shooting method with varying b for $n=1,2,3$}
\end{table}
While varying $b$ (which is a finite representation for infinity) we find that stability is lost for a choice of $b > 14$ in the case of $n=1$ and $b>16$ for $n=2,3$. \\
The instability of smaller $n$ in this case can be attributed to the slower growth of the solution as we choose larger $n$. Looking at the system we solve we have multiple terms containing $\frac{1}{1-u^2}$ which causes division by a small number the closer $u$ is to 1. Solutions for larger $n$ exhibit better stability properties as they have less values that are close to one than solutions with small $n$. 
\subsubsection{Varing step size}
Testing the step size with the chosen fixed values does not yeild any interesting results as soltions are stable for all rational stepsizes greater than zero. \\
However the step size does play a role in stability as a small step size can cause many more divisions by small $r$ if we choose $a=0$ or some other very small $a$. The $a$ that we fix here is succiciently large to negate this impact for all values of $n$. 
\subsubsection{Varing bisection vs Newton}
TBD.

\subsection{Newton-Kantorovich method}
\includegraphics[scale=1]{NK.png}
\subsubsection{Varing a}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
a & n=1  & n=2 & n=3 \\
\hline
0.00 & 0 & 1 & 1\\
0.01 & 0 & 1 & 1\\
0.02 & 0 & 1 & 1\\
0.03 & 0 & 1 & 1\\
0.04 & 0 & 1 & 1\\
0.05 & 0 & 1 & 1\\
0.06 & 1 & 1 & 1\\
0.07 & 0 & 1 & 1\\
0.08 & 0 & 0 & 0\\
0.09 & 0 & 0 & 0\\
0.1 & 0 & 0 & 0\\
\hline
\end{tabular}
\caption{This table shows the convergence of the NK method with varying a for $n=1,2,3$}
\end{table}
These results have some interesting charactersitics that are a large contrast to those of the shooting method. We see that for $n=2,3$ that small and zero values for $a$ produce stable solutions and large values for $a$, namely $a>0.07$ induces instability. This is likely due to the nature of the method relying less heavily on terms containing $\frac{1}{r}$. \\
The case for $n=1$ is strange as we only see a stable solution produced for $a=0.06$, it is not clear why this is however, it is likely due to some complex interations between a variaety of different elements. More analysis is needed here to find the exact reason, it may be an error in the implementation of the method. 
\subsubsection{Varing b}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
b & n=1 & n=2 & n=3\\
\hline
4  & 1 & 1 & 1\\
6  & 0 & 1 & 1\\
8  & 0 & 0 & 1\\
10 & 0 & 0 & 1\\
12 & 0 & 0 & 0\\
14 & 0 & 0 & 0\\
16 & 0 & 0 & 0\\
18 & 0 & 0 & 0\\
20 & 0 & 0 & 0\\
22 & 0 & 0 & 0\\
24 & 0 & 0 & 0\\
\hline
\end{tabular}
\caption{This table shows the convergence of the NK method with varying b for $n=1,2,3$}
\end{table}
As with the shooting method we see that larger values of $n$ have a larger range of stability in $b$. This is likely due once again the the slower growth to $1$. There is little more insight to be gained here, however, one should note that the stability of this method for the same fixed parameters is worse than that of the nonlinear shooting method as $b$ grows. 
\subsubsection{Varing N}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
N & n=1 &  n=2 &  n=3 \\
\hline
10   & 0 & 1 & 1\\
110  & 0 & 1 & 1\\
210  & 0 & 1 & 1\\
310  & 0 & 1 & 1\\
410  & 0 & 1 & 1\\
510  & 0 & 1 & 1\\
610  & 0 & 1 & 1\\
710  & 0 & 1 & 1\\
810  & 0 & 1 & 1\\
910  & 1 & 1 & 1\\
1010 & 0 & 1 & 1\\
\hline
\end{tabular}
\caption{This table shows the convergence of the NK method with varying N for $n=1,2,3$}
\end{table}
The results here are quite surprising, with solutions for $n=1$ only being stable for $N=910$ while for larger $n$ solutions are stable for all $N$ in the testing. This is likely due to poor choice of testing parameters for $n=1$ as they inherintly cause instability, see 6.2.3 for similar results. \\
Collectively we can assume that $N$ has a similar effect to that of the step size in the shooting method as a low number of mesh points can give rise to stability by ignoring problamatic areas while a large number of mesh points can also give rise to stability where critical detail is needed to form a stable solution. This means that choosing a good value for $N$ is problem dependent, for our vortex solutions we know that when using the Newton-Kantorovich method that there are no points that cause instability so a low $N$ is not required, we can see in the varying of $N$ that when the choice of other parameters is poor a good $N$ value can still produce stable solutions. 
\subsubsection{Varing initial guess}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|}
%                                           &   \\
%guess 1=linear, 2=sigmoid, 3=-e-r+1, 4=log &   \\
\hline
N                                          & linear  & sigmoid & $-e^-r + 1 $&log \\
\hline
4  & 1 & 1 & 1 & 1\\
6  & 0 & 0 & 0 & 0\\
8  & 0 & 0 & 0 & 0 \\
10 & 0 & 0 & 0 & 0 \\
12 & 0 & 0 & 0 & 0 \\
14 & 0 & 0 & 0 & 0 \\
16 & 0 & 0 & 0 & 0 \\
\hline
\end{tabular}
\caption{This table shows the convergence of the NK method with varying N and initial guess $u^0$ for $n=1$}
\end{table}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
N                                          & linear  & sigmoid & $-e^-r + 1$ &log \\
\hline
4                                          & 1 & 1 & 1 &1\\
6                                          & 1 & 1 & 1 &0\\
8                                          & 0 & 0 & 1 &0\\
10                                         & 0 & 0 & 0 &0\\
12                                         & 0 & 0 & 0 &0\\
14                                         & 0 & 0 & 0 &0\\
16                                         & 0 & 0 & 0 &0\\
\hline
\end{tabular}
\caption{This table shows the convergence of the NK method with varying N and initial guess $u^0$ for $n=2$}
\end{table}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
N                                          & linear  & sigmoid & $-e^-r + 1$ &log \\
\hline
4                                          & 1 & 1 & 1 & 1\\
6                                          & 1 & 1 & 1 & 0\\
8                                          & 1 & 1 & 1 & 0\\
10                                         & 1 & 0 & 1 & 0\\
12                                         & 0 & 0 & 0 & 0\\
14                                         & 0 & 0 & 0 & 0\\
16                                         & 0 & 0 & 0 & 0\\
\hline
\end{tabular}
\caption{This table shows the convergence of the NK method with varying N and initial guess $u^0$ for $n=3$}
\end{table}

\section{Conclusion and final remarks}
GGGGGGG
\end{document}